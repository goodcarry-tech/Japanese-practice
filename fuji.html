<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff9a9e">
    <title>æ—¥èªäº”åéŸ³ï¼š4Kæ¸…æ™°æ«»èŠ±ç‰ˆ</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/144/sakura.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap');

        :root {
            --primary: #ff85a2; /* æ›´é£½å’Œçš„æ«»èŠ±ç²‰ */
            --primary-dark: #e84393;
            --text: #2d3436;
            --card-bg: rgba(255, 255, 255, 0.95); /* é«˜ä¸é€æ˜åº¦ï¼Œä¸ä½¿ç”¨æ¨¡ç³Š */
            --success: #00b894;
            --error: #ff7675;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            overflow: hidden;
            /* ğŸŒŸ 4K è¶…é«˜æ¸…èƒŒæ™¯ï¼šå¯Œå£«å±±èˆ‡æ«»èŠ± (q=100 å“è³ªå…¨é–‹) */
            background: url('https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?q=100&w=3840&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            touch-action: manipulation;
        }

        /* ğŸŒ¸ æ«»èŠ±ç‰¹æ•ˆå±¤ */
        #sakura-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .petal {
            position: absolute;
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 150% 0 150% 0;
            animation: fall linear infinite;
            opacity: 0.95; /* æé«˜ä¸é€æ˜åº¦ï¼Œè®“èŠ±ç“£æ›´æ¸…æ¥š */
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
        }

        @keyframes fall {
            0% { opacity: 0; transform: translate(0, -10vh) rotate(0deg); }
            10% { opacity: 1; }
            100% { opacity: 0; transform: translate(80px, 110vh) rotate(360deg); }
        }

        /* ä¸»å®¹å™¨ - ç§»é™¤ backdrop-filter (æ¨¡ç³Šæ¿¾é¡) */
        .container {
            position: relative;
            z-index: 10;
            background: var(--card-bg); /* ç´”æ·¨èƒŒæ™¯ï¼Œç„¡æ¨¡ç³Š */
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 3px solid rgba(255, 255, 255, 0.8);
            width: 85%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* âŒ é€™è£¡ç§»é™¤äº† backdrop-filter: blur(...) */
        }

        /* ä»‹é¢å…ƒä»¶ */
        .header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; border-bottom: 2px dashed #ffb7b2; padding-bottom: 10px;
        }
        h1 { font-size: 1.4rem; margin: 0; color: var(--primary-dark); text-shadow: none; }
        
        .progress-badge {
            background: var(--primary);
            color: white; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8rem;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; align-items: center; }
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; width: 100%; justify-content: center; padding-bottom: 5px; }
        .chip { padding: 6px 12px; border-radius: 20px; background: #fff0f5; border: 1px solid #ffb7b2; color: #d63031; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: 0.2s; font-weight: bold; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

        .speed-control {
            display: flex; align-items: center; gap: 10px; background: #fff0f5;
            padding: 8px 15px; border-radius: 20px; width: 85%; justify-content: center;
            color: #636e72; font-size: 0.85rem; border: 1px solid #ffb7b2;
        }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 5px; border-radius: 5px; background: #dfe6e9; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .toggle-group { display: flex; gap: 5px; background: #fff0f5; padding: 3px 10px; border-radius: 20px; border: 1px solid #ffb7b2; margin-top: 5px; }
        .mode-btn { background: none; border: none; color: #b2bec3; cursor: pointer; font-weight: bold; font-size: 0.85rem; padding: 5px 10px; border-radius: 15px; transition: 0.2s; }
        .mode-btn.active { background: var(--primary-dark); color: white; }

        /* å¡ç‰‡ */
        .flashcard {
            width: 180px; height: 200px; background: white; border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(232, 67, 147, 0.2); border: 3px solid #ffeaa7;
            cursor: pointer; transition: transform 0.2s; margin-bottom: 15px;
        }
        .flashcard:active { transform: scale(0.95); }
        .flashcard.wrong-shake { border-color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-8px);} 75% {transform: translateX(8px);} }

        .kana-char { font-size: 4.5rem; font-weight: 700; color: var(--text); line-height: 1; }
        .romaji-hint { font-size: 1.2rem; color: #fab1a0; margin-top: 10px; opacity: 0; transition: 0.3s; }
        .flashcard:hover .romaji-hint { opacity: 1; }

        .input-section { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* è²æ³¢è¦–è¦ºåŒ–æ¢ */
        .visualizer-container {
            width: 200px; height: 10px; display: flex; justify-content: center; align-items: center; gap: 4px;
            margin-bottom: 10px; opacity: 0; transition: opacity 0.3s;
        }
        .visualizer-bar {
            width: 5px; background-color: #2ecc71; border-radius: 5px;
            height: 5px; transition: height 0.05s;
        }

        .status-log { 
            font-size: 1rem; color: #2d3436; min-height: 2.5rem; margin-bottom: 15px; 
            font-weight: 700; background: #fff; padding: 10px 15px; 
            border-radius: 12px; border: 2px solid #ffb7b2;
            width: 90%; text-align: center; display: flex; align-items: center; justify-content: center;
            line-height: 1.4;
        }
        
        .mic-btn { 
            width: 80px; height: 80px; border-radius: 50%; 
            background: linear-gradient(135deg, #ff9a9e 0%, #ff6b6b 100%); 
            border: 4px solid white; color: white; font-size: 2.2rem; cursor: pointer; 
            box-shadow: 0 8px 20px rgba(232, 67, 147, 0.4); 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.listening { background: var(--error); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,118,117,0.7);} 70% {box-shadow: 0 0 0 20px rgba(0,0,0,0);} 100% {box-shadow: 0 0 0 0 rgba(0,0,0,0);} }

        input[type="text"] { width: 220px; padding: 12px 20px; font-size: 1.2rem; border: 2px solid #ffc3a0; border-radius: 50px; text-align: center; outline: none; font-family: 'Zen Maru Gothic', sans-serif; }

        #result-view { display: none; width: 100%; text-align: center; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: white; border: 5px solid #ff85a2; margin: 0 auto 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--primary-dark); }
        .ranking-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding: 5px; }
        .rank-item { background: white; padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .btn-action { width: 100%; margin-top: 15px; padding: 14px; border: none; border-radius: 50px; background: var(--primary-dark); color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div id="sakura-container"></div>

    <div class="container">
        <div id="practice-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="header">
                <h1>æ«»èŠ±ç‰¹è¨“ãƒ»é«˜æ¸…ç‰ˆ</h1>
                <div class="progress-badge" id="progress-text">1 / 25</div>
            </div>

            <div class="control-panel">
                <div class="category-scroll">
                    <div class="chip active" onclick="setCategory('seion', this)">æ¸…éŸ³</div>
                    <div class="chip" onclick="setCategory('dakuon', this)">æ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('handakuon', this)">åŠæ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('yoon', this)">æ‹—éŸ³</div>
                    <div class="chip" onclick="setCategory('all', this)">å…¨éƒ¨</div>
                </div>
                <div class="speed-control">
                    <span>ğŸ¢</span>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" oninput="updateSpeed(this.value)">
                    <span id="speed-display" style="font-weight:bold; width:40px;">1.0x</span>
                    <span>ğŸ°</span>
                </div>
                <div class="toggle-group">
                    <button class="mode-btn active" id="btn-voice" onclick="setInputMode('voice')">ğŸ¤ èªéŸ³</button>
                    <button class="mode-btn" id="btn-type" onclick="setInputMode('type')">âŒ¨ï¸ æ‰“å­—</button>
                    <span>|</span>
                    <button class="mode-btn active" onclick="setKana('h', this)">å¹³å‡å</button>
                    <button class="mode-btn" onclick="setKana('k', this)">ç‰‡å‡å</button>
                </div>
            </div>

            <div class="flashcard" id="flashcard" onclick="playAudio()">
                <div class="kana-char" id="kana-display">ã‚</div>
                <div class="romaji-hint" id="romaji-hint">a</div>
                <div style="font-size: 0.75rem; color: #b2bec3; position: absolute; bottom: 10px;">ğŸ”Š é»æ“Šè½ç™¼éŸ³</div>
            </div>

            <div class="input-section">
                <!-- è²æ³¢æ¢ -->
                <div class="visualizer-container" id="visualizer">
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                </div>
                
                <div id="status-log" class="status-log">æº–å‚™å°±ç·’<br>è«‹æŒ‰éº¥å…‹é¢¨</div>
                <button id="mic-btn" class="mic-btn" onclick="toggleSpeech()">ğŸ¤</button>
                <input type="text" id="text-input" style="display:none;" placeholder="è¼¸å…¥ç¾…é¦¬æ‹¼éŸ³" autocomplete="off">
            </div>
        </div>

        <div id="result-view">
            <h2 style="color:var(--primary-dark); margin-bottom:15px;">ğŸŒ¸ ç·´ç¿’å®Œæˆ ğŸŒ¸</h2>
            <div class="score-circle">
                <span style="font-size:2.5rem; font-weight:bold;" id="final-score">0</span>
                <span style="font-size:0.8rem;">æœ€çµ‚å¾—åˆ†</span>
            </div>
            <div class="ranking-list" id="ranking-container"></div>
            <button class="btn-action" onclick="restartSession()">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>

    <script>
        // --- æ«»èŠ±ç‰¹æ•ˆ (é«˜å¯†åº¦+å¤§èŠ±ç“£) ---
        function createSakura() {
            const c = document.getElementById('sakura-container');
            const p = document.createElement('div'); p.className = 'petal';
            const size = Math.random()*12+8; // å¢å¤§å°ºå¯¸
            p.style.left = Math.random()*window.innerWidth+'px';
            p.style.width = size+'px'; p.style.height = size+'px';
            p.style.animationDuration = (Math.random()*5+4)+'s';
            c.appendChild(p); setTimeout(()=>p.remove(), 9000);
        }
        setInterval(createSakura, 80); // 80ms ä¸€ç‰‡

        // --- æ•¸æ“š ---
        const gojuonDB = { seion:[{r:'a',h:'ã‚',k:'ã‚¢'},{r:'i',h:'ã„',k:'ã‚¤'},{r:'u',h:'ã†',k:'ã‚¦'},{r:'e',h:'ãˆ',k:'ã‚¨'},{r:'o',h:'ãŠ',k:'ã‚ª'},{r:'ka',h:'ã‹',k:'ã‚«'},{r:'ki',h:'ã',k:'ã‚­'},{r:'ku',h:'ã',k:'ã‚¯'},{r:'ke',h:'ã‘',k:'ã‚±'},{r:'ko',h:'ã“',k:'ã‚³'},{r:'sa',h:'ã•',k:'ã‚µ'},{r:'shi',h:'ã—',k:'ã‚·'},{r:'su',h:'ã™',k:'ã‚¹'},{r:'se',h:'ã›',k:'ã‚»'},{r:'so',h:'ã',k:'ã‚½'},{r:'ta',h:'ãŸ',k:'ã‚¿'},{r:'chi',h:'ã¡',k:'ãƒ'},{r:'tsu',h:'ã¤',k:'ãƒ„'},{r:'te',h:'ã¦',k:'ãƒ†'},{r:'to',h:'ã¨',k:'ãƒˆ'},{r:'na',h:'ãª',k:'ãƒŠ'},{r:'ni',h:'ã«',k:'ãƒ‹'},{r:'nu',h:'ã¬',k:'ãƒŒ'},{r:'ne',h:'ã­',k:'ãƒ'},{r:'no',h:'ã®',k:'ãƒ'},{r:'ha',h:'ã¯',k:'ãƒ'},{r:'hi',h:'ã²',k:'ãƒ’'},{r:'fu',h:'ãµ',k:'ãƒ•'},{r:'he',h:'ã¸',k:'ãƒ˜'},{r:'ho',h:'ã»',k:'ãƒ›'},{r:'ma',h:'ã¾',k:'ãƒ'},{r:'mi',h:'ã¿',k:'ãƒŸ'},{r:'mu',h:'ã‚€',k:'ãƒ '},{r:'me',h:'ã‚',k:'ãƒ¡'},{r:'mo',h:'ã‚‚',k:'ãƒ¢'},{r:'ya',h:'ã‚„',k:'ãƒ¤'},{r:'yu',h:'ã‚†',k:'ãƒ¦'},{r:'yo',h:'ã‚ˆ',k:'ãƒ¨'},{r:'ra',h:'ã‚‰',k:'ãƒ©'},{r:'ri',h:'ã‚Š',k:'ãƒª'},{r:'ru',h:'ã‚‹',k:'ãƒ«'},{r:'re',h:'ã‚Œ',k:'ãƒ¬'},{r:'ro',h:'ã‚',k:'ãƒ­'},{r:'wa',h:'ã‚',k:'ãƒ¯'},{r:'wo',h:'ã‚’',k:'ãƒ²'},{r:'n',h:'ã‚“',k:'ãƒ³'}], dakuon:[{r:'ga',h:'ãŒ',k:'ã‚¬'},{r:'gi',h:'ã',k:'ã‚®'},{r:'gu',h:'ã',k:'ã‚°'},{r:'ge',h:'ã’',k:'ã‚²'},{r:'go',h:'ã”',k:'ã‚´'},{r:'za',h:'ã–',k:'ã‚¶'},{r:'ji',h:'ã˜',k:'ã‚¸'},{r:'zu',h:'ãš',k:'ã‚º'},{r:'ze',h:'ãœ',k:'ã‚¼'},{r:'zo',h:'ã',k:'ã‚¾'},{r:'da',h:'ã ',k:'ãƒ€'},{r:'ji',h:'ã¢',k:'ãƒ‚'},{r:'zu',h:'ã¥',k:'ãƒ…'},{r:'de',h:'de',k:'ãƒ‡'},{r:'do',h:'ã©',k:'ãƒ‰'},{r:'ba',h:'ã°',k:'ãƒ'},{r:'bi',h:'ã³',k:'ãƒ“'},{r:'bu',h:'ã¶',k:'ãƒ–'},{r:'be',h:'ã¹',k:'ãƒ™'},{r:'bo',h:'ã¼',k:'ãƒœ'}], handakuon:[{r:'pa',h:'ã±',k:'ãƒ‘'},{r:'pi',h:'ã´',k:'ãƒ”'},{r:'pu',h:'ã·',k:'ãƒ—'},{r:'pe',h:'ãº',k:'ãƒš'},{r:'po',h:'ã½',k:'ãƒ'}], yoon:[{r:'kya',h:'ãã‚ƒ',k:'ã‚­ãƒ£'},{r:'kyu',h:'ãã‚…',k:'ã‚­ãƒ¥'},{r:'kyo',h:'ãã‚‡',k:'ã‚­ãƒ§'},{r:'sha',h:'ã—ã‚ƒ',k:'ã‚·ãƒ£'},{r:'shu',h:'ã—ã‚…',k:'ã‚·ãƒ¥'},{r:'sho',h:'ã—ã‚‡',k:'ã‚·ãƒ§'},{r:'cha',h:'ã¡ã‚ƒ',k:'ãƒãƒ£'},{r:'chu',h:'ã¡ã‚…',k:'ãƒãƒ¥'},{r:'cho',h:'ã¡ã‚‡',k:'ãƒãƒ§'},{r:'nya',h:'ã«ã‚ƒ',k:'ãƒ‹ãƒ£'},{r:'nyu',h:'ã«ã‚…',k:'ãƒ‹ãƒ¥'},{r:'nyo',h:'ã«ã‚‡',k:'ãƒ‹ãƒ§'},{r:'hya',h:'ã²ã‚ƒ',k:'ãƒ’ãƒ£'},{r:'hyu',h:'ã²ã‚…',k:'ãƒ’ãƒ¥'},{r:'hyo',h:'ã²ã‚‡',k:'ãƒ’ãƒ§'},{r:'mya',h:'ã¿ã‚ƒ',k:'ãƒŸãƒ£'},{r:'myu',h:'ã¿ã‚…',k:'ãƒŸãƒ¥'},{r:'myo',h:'ã¿ã‚‡',k:'ãƒŸãƒ§'},{r:'rya',h:'ã‚Šã‚ƒ',k:'ãƒªãƒ£'},{r:'ryu',h:'ã‚Šã‚…',k:'ãƒªãƒ¥'},{r:'ryo',h:'ã‚Šã‚‡',k:'ãƒªãƒ§'},{r:'gya',h:'ãã‚ƒ',k:'ã‚®ãƒ£'},{r:'gyu',h:'ãã‚…',k:'ã‚®ãƒ¥'},{r:'gyo',h:'ãã‚‡',k:'ã‚®ãƒ§'},{r:'ja',h:'ã˜ã‚ƒ',k:'ã‚¸ãƒ£'},{r:'ju',h:'ã˜ã‚…',k:'ã‚¸ãƒ¥'},{r:'jo',h:'ã˜ã‚‡',k:'ã‚¸ãƒ§'},{r:'bya',h:'ã³ã‚ƒ',k:'ãƒ“ãƒ£'},{r:'byu',h:'ã³ã‚…',k:'ãƒ“ãƒ¥'},{r:'byo',h:'ã³ã‚‡',k:'ãƒ“ãƒ§'},{r:'pya',h:'ã´ã‚ƒ',k:'ãƒ”ãƒ£'},{r:'pyu',h:'ã´ã‚…',k:'ãƒ”ãƒ¥'},{r:'pyo',h:'ã´ã‚‡',k:'ãƒ”ãƒ§'}] };

        const QUESTIONS_LIMIT = 25;
        let sessionData = { count: 0, correct: 0 };
        let state = { category: 'seion', kanaType: 'h', inputMode: 'voice', currentCard: null, pool: [] };
        let globalMistakes = JSON.parse(localStorage.getItem('gojuon_sakura_mistakes_app')) || {};
        let recognition = null;
        let isListening = false;
        let speechRate = 1.0;
        
        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;

        window.onload = function() {
            initPool();
            nextQuestion();
        };

        function startVisualizer(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;
            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);
            const bars = document.querySelectorAll('.visualizer-bar');
            document.getElementById('visualizer').style.opacity = '1';

            javascriptNode.onaudioprocess = function() {
                var array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                var values = 0;
                for (var i = 0; i < array.length; i++) values += array[i];
                var average = values / array.length;
                bars.forEach(bar => { bar.style.height = Math.min(5 + average * 2, 35) + 'px'; });
            }
        }

        function stopVisualizer() {
            if(javascriptNode) javascriptNode.disconnect();
            if(microphone) microphone.disconnect();
            if(analyser) analyser.disconnect();
            if(audioContext) audioContext.close();
            document.getElementById('visualizer').style.opacity = '0';
        }

        function initSpeech() {
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿå…§å»ºç€è¦½å™¨
            const isInApp = /Line|FB|Instagram/i.test(navigator.userAgent);
            if (isInApp) {
                logStatus("âš ï¸ è«‹é»é¸å³ä¸Šè§’<br>ç”¨ Chrome/Safari é–‹å•Ÿ");
                return;
            }

            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = true; 
                recognition.maxAlternatives = 5;

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('mic-btn').classList.add('listening');
                    logStatus("ğŸ‘‚ æ­£åœ¨è†è½...<br>è«‹çœ‹ç¶ è‰²è²æ³¢");
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) { startVisualizer(stream); })
                        .catch(function(err) { console.log(err); });
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('mic-btn').classList.remove('listening');
                    stopVisualizer();
                    setTimeout(() => {
                        const log = document.getElementById('status-log').innerText;
                        if (log.includes("æ­£åœ¨è†è½")) logStatus("âŒ æ²’è½åˆ°è²éŸ³<br>è«‹é è¿‘æ‰‹æ©Ÿåº•éƒ¨");
                    }, 200);
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            checkAnswer(event.results[i][0].transcript);
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                            logStatus(`ğŸ‘‚ æª¢æ¸¬ä¸­: ${interimTranscript}`);
                        }
                    }
                };

                recognition.onerror = (event) => {
                    isListening = false;
                    stopVisualizer();
                    document.getElementById('mic-btn').classList.remove('listening');
                    if (event.error === 'no-speech') logStatus("âŒ æ²’è½åˆ°è²éŸ³");
                    else if (event.error === 'not-allowed') logStatus("â›” éº¥å…‹é¢¨è¢«æ‹’");
                    else logStatus("âš ï¸ éŒ¯èª¤: " + event.error);
                };
            } else {
                alert("è«‹ä½¿ç”¨ Chrome (Android) æˆ– Safari (iOS)");
            }
        }

        function toggleSpeech() {
            if(!recognition) initSpeech();
            if(!recognition) return;
            if (isListening) { recognition.stop(); } else { recognition.start(); }
        }

        function updateSpeed(v){ speechRate = parseFloat(v); document.getElementById('speed-display').innerText = speechRate + 'x'; }
        function playAudio() { 
            if(!state.currentCard) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(state.currentCard.h);
            u.lang = 'ja-JP'; u.rate = speechRate;
            window.speechSynthesis.speak(u); 
        }
        function logStatus(msg) { document.getElementById('status-log').innerHTML = msg; }
        
        function nextQuestion() {
            if (sessionData.count >= QUESTIONS_LIMIT) { showResults(); return; }
            sessionData.count++;
            document.getElementById('progress-text').innerText = `${sessionData.count} / ${QUESTIONS_LIMIT}`;
            const rand = Math.floor(Math.random() * state.pool.length);
            state.currentCard = state.pool[rand];
            updateCardUI();
            document.getElementById('flashcard').classList.remove('wrong-shake');
            document.getElementById('text-input').value = '';
            if(state.inputMode==='voice') logStatus("é»æ“Šéº¥å…‹é¢¨é–‹å§‹");
        }

        function updateCardUI() {
            if(!state.currentCard) return;
            const char = state.kanaType === 'h' ? state.currentCard.h : state.currentCard.k;
            document.getElementById('kana-display').innerText = char;
            document.getElementById('romaji-hint').innerText = state.currentCard.r;
        }

        function checkAnswer(inputRaw) {
            const input = inputRaw.toLowerCase().replace(/[.ã€‚ã€!?\s]/g, '').trim();
            const target = state.currentCard;
            let isCorrect = false;
            if(state.inputMode==='voice') {
                if(input===target.h || input===target.k || input===target.r || input===target.r.replace('fu','hu') || input.includes(target.h)) isCorrect = true;
            } else {
                isCorrect = (input === target.r);
            }

            if(isCorrect) {
                sessionData.correct++;
                logStatus("âœ… æ­£ç¢ºï¼");
                playAudio();
                if(recognition) recognition.stop();
                setTimeout(nextQuestion, 1000);
            } else {
                logStatus(`âŒ è­˜åˆ¥ç‚º: ${input}`);
                document.getElementById('flashcard').classList.add('wrong-shake');
                recordMistake(target);
                if(recognition) recognition.stop();
                setTimeout(nextQuestion, 1500);
            }
        }

        function setCategory(cat, btn) { state.category=cat; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); restartSession(); }
        function setInputMode(mode) { 
            state.inputMode=mode; 
            document.getElementById('btn-voice').className = mode==='voice'?'mode-btn active':'mode-btn';
            document.getElementById('btn-type').className = mode==='type'?'mode-btn active':'mode-btn';
            if(mode==='type'){ document.getElementById('mic-btn').style.display='none'; document.getElementById('text-input').style.display='block'; document.getElementById('visualizer').style.display='none';} 
            else { document.getElementById('mic-btn').style.display='flex'; document.getElementById('text-input').style.display='none'; document.getElementById('visualizer').style.display='flex';}
        }
        function setKana(type, btn) { state.kanaType=type; btn.parentElement.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); updateCardUI(); }
        document.getElementById('text-input').addEventListener('keyup', (e)=>{if(e.key==='Enter')checkAnswer(e.target.value)});

        function recordMistake(card) {
            const key = card.r;
            if (!globalMistakes[key]) globalMistakes[key] = { count: 0, char: card.h, romaji: card.r };
            globalMistakes[key].count++;
            localStorage.setItem('gojuon_sakura_mistakes_app', JSON.stringify(globalMistakes));
        }
        function showResults() {
            document.getElementById('practice-view').style.display='none'; document.getElementById('result-view').style.display='block';
            document.getElementById('final-score').innerText = Math.round((sessionData.correct/QUESTIONS_LIMIT)*100);
            const container = document.getElementById('ranking-container'); container.innerHTML='';
            const sorted = Object.values(globalMistakes).sort((a,b)=>b.count-a.count).slice(0,20);
            if(sorted.length===0) container.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#ccc">å®Œç¾ï¼</div>';
            sorted.forEach(i=>{ container.innerHTML+=`<div class="rank-item"><div><span style="font-weight:bold;font-size:1.2rem">${i.char}</span> <span style="color:#999">${i.romaji}</span></div><span style="color:#e67e22">${i.count}æ¬¡</span></div>`; });
        }
        function restartSession() { sessionData={count:0,correct:0}; initPool(); document.getElementById('practice-view').style.display='flex'; document.getElementById('result-view').style.display='none'; nextQuestion(); }
    </script>
</body>
</html>