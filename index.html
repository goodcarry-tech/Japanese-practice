<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff9a9e">
    <title>æ—¥èªäº”åéŸ³ï¼šèªéŸ³å­¸ç¿’æ©Ÿ (Pro)</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/144/sakura.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap');

        :root {
            --primary: #ff85a2;
            --primary-dark: #e84393;
            --text: #2d3436;
            /* å„ªåŒ–äºŒï¼šé«˜ä¸é€æ˜åº¦ç´”ç™½èƒŒæ™¯ï¼Œä¸ä½¿ç”¨æ¨¡ç³Š */
            --card-bg: rgba(255, 255, 255, 0.93); 
            --success: #00b894;
            --error: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            margin: 0;
            min-height: 100vh;
            /* ä½¿ç”¨ dvh è§£æ±ºæ‰‹æ©Ÿç¶²å€åˆ—é®æ“‹å•é¡Œ */
            min-height: 100dvh; 
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            overflow-x: hidden;
            overflow-y: auto;
            /* 4K æ¸…æ™°æ«»èŠ±èƒŒæ™¯ */
            background: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=100&w=2800&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
        }

        /* æ«»èŠ±é£„è½å±¤ */
        #sakura-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }
        .petal {
            position: absolute;
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 150% 0 150% 0;
            animation: fall linear infinite;
            opacity: 0.9;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
        }
        @keyframes fall {
            0% { opacity: 0; transform: translate(0, -10vh) rotate(0deg); }
            100% { opacity: 0; transform: translate(80px, 110vh) rotate(360deg); }
        }

        /* ä¸»å®¹å™¨ï¼šç§»é™¤ backdrop-filter */
        .container {
            position: relative;
            z-index: 10;
            background: var(--card-bg);
            padding: 1.2rem;
            border-radius: 24px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            border: 2px solid rgba(255, 255, 255, 1);
            width: 90%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px auto;
        }

        /* æ¨™é¡Œèˆ‡è¨­å®š */
        .header {
            width: 100%; display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 1rem; border-bottom: 2px dashed #ffc3a0; padding-bottom: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        h1 { font-size: 1.4rem; margin: 0; color: var(--primary-dark); }
        .progress-badge { background: linear-gradient(to right, #ff9a9e, #fecfef); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }

        /* é—œéµå„ªåŒ–ï¼šèªéŸ³é¸æ“‡å™¨ */
        .voice-settings {
            width: 100%;
            background: #fff0f5;
            padding: 8px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .voice-label { font-size: 0.8rem; color: #d63031; font-weight: bold; }
        select#voice-select {
            width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ffb7b2;
            background: white; color: #2d3436; font-size: 0.9rem;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; align-items: center; }
        .category-scroll { display: flex; gap: 6px; overflow-x: auto; width: 100%; justify-content: center; padding-bottom: 5px; }
        .chip { padding: 6px 12px; border-radius: 20px; background: #fff; border: 1px solid #ffc3a0; color: var(--text); font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); font-weight: bold;}

        .toggle-group { display: flex; gap: 5px; background: #fff; padding: 4px 10px; border-radius: 20px; border: 1px solid #ffc3a0; }
        .mode-btn { background: none; border: none; color: #b2bec3; cursor: pointer; font-weight: bold; font-size: 0.85rem; padding: 5px 12px; border-radius: 15px; transition: 0.2s; }
        .mode-btn.active { background: var(--primary-dark); color: white; }

        /* å¡ç‰‡ */
        .flashcard {
            width: 160px; height: 180px; background: white; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.25); border: 4px solid white;
            cursor: pointer; transition: transform 0.2s; margin-bottom: 10px;
            position: relative;
        }
        .flashcard:active { transform: scale(0.95); }
        .flashcard.wrong-shake { border-color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-8px);} 75% {transform: translateX(8px);} }

        .kana-char { font-size: 4.5rem; font-weight: 700; color: var(--text); line-height: 1; }
        .romaji-hint { font-size: 1.1rem; color: #fab1a0; margin-top: 5px; opacity: 0; transition: 0.3s; }
        .flashcard:hover .romaji-hint { opacity: 1; }

        /* å„ªåŒ–ä¸€ï¼šç¶ è‰²è²æ³¢æ¢ (Visualizer) */
        .input-section { width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; }
        
        .visualizer-container {
            width: 200px; height: 20px; display: flex; justify-content: center; align-items: flex-end; gap: 4px;
            margin-bottom: 10px;
        }
        .visualizer-bar {
            width: 6px; background-color: #dfe6e9; border-radius: 3px;
            height: 4px; transition: height 0.05s ease-in-out, background-color 0.2s;
        }
        /* ç•¶æª¢æ¸¬åˆ°è²éŸ³æ™‚è®Šç¶  */
        .visualizer-container.active .visualizer-bar { background-color: var(--success); }

        /* ç‹€æ…‹æç¤º */
        .status-log { 
            font-size: 0.95rem; color: #636e72; min-height: 2.5rem; margin-bottom: 10px; 
            font-weight: bold; background: #fff; padding: 8px 15px; 
            border-radius: 12px; border: 2px solid #ffc3a0;
            width: 100%; text-align: center; display: flex; align-items: center; justify-content: center;
            line-height: 1.4;
        }
        
        .mic-btn { 
            width: 75px; height: 75px; border-radius: 50%; 
            background: linear-gradient(135deg, #ff9a9e 0%, #ff7675 100%); 
            border: 5px solid white; color: white; font-size: 2rem; cursor: pointer; 
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.5); 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.listening { background: var(--error); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7);} 70% {box-shadow: 0 0 0 20px rgba(0,0,0,0);} 100% {box-shadow: 0 0 0 0 rgba(0,0,0,0);} }

        input[type="text"] { width: 220px; padding: 10px 20px; font-size: 1.2rem; border: 2px solid #ffc3a0; border-radius: 50px; text-align: center; outline: none; font-family: 'Zen Maru Gothic', sans-serif; }

        /* çµç®— */
        #result-view { display: none; width: 100%; text-align: center; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: white; border: 5px solid #ff85a2; margin: 0 auto 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--primary-dark); }
        .ranking-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding: 5px; }
        .rank-item { background: white; padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .btn-action { width: 100%; margin-top: 15px; padding: 12px; border: none; border-radius: 50px; background: var(--primary-dark); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="sakura-container"></div>

    <div class="container">
        <div id="practice-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="header">
                <div class="header-top">
                    <h1>äº”åéŸ³èªéŸ³æ©Ÿ</h1>
                    <div class="progress-badge" id="progress-text">1 / 25</div>
                </div>
                
                <!-- å„ªåŒ–é—œéµï¼šèªéŸ³é¸æ“‡ä¸‹æ‹‰é¸å–® -->
                <div class="voice-settings">
                    <div class="voice-label">ğŸ”Š é¸æ“‡ç™¼éŸ³äºº (è‹¥æ²’è²éŸ³è«‹åˆ‡æ›)</div>
                    <select id="voice-select" onchange="playAudio(true)">
                        <option value="">è¼‰å…¥èªéŸ³ä¸­...</option>
                    </select>
                </div>
            </div>

            <div class="control-panel">
                <div class="category-scroll">
                    <div class="chip active" onclick="setCategory('seion', this)">æ¸…éŸ³</div>
                    <div class="chip" onclick="setCategory('dakuon', this)">æ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('handakuon', this)">åŠæ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('yoon', this)">æ‹—éŸ³</div>
                    <div class="chip" onclick="setCategory('all', this)">å…¨éƒ¨</div>
                </div>
                
                <div class="toggle-group">
                    <button class="mode-btn active" id="btn-voice" onclick="setInputMode('voice')">ğŸ¤ èªéŸ³æ¨¡å¼</button>
                    <button class="mode-btn" id="btn-type" onclick="setInputMode('type')">âŒ¨ï¸ æ‰“å­—æ¨¡å¼</button>
                    <span>|</span>
                    <button class="mode-btn active" onclick="setKana('h', this)">å¹³å‡å</button>
                    <button class="mode-btn" onclick="setKana('k', this)">ç‰‡å‡å</button>
                </div>
            </div>

            <div class="flashcard" id="flashcard" onclick="playAudio()">
                <div class="kana-char" id="kana-display">ã‚</div>
                <div class="romaji-hint" id="romaji-hint">a</div>
                <div style="font-size: 0.75rem; color: #b2bec3; position: absolute; bottom: 10px;">ğŸ”Š é»æ“Šè½ç™¼éŸ³</div>
            </div>

            <div class="input-section">
                <!-- å„ªåŒ–é—œéµï¼šç¶ è‰²è²æ³¢æ¢ -->
                <div class="visualizer-container" id="visualizer">
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div><div class="visualizer-bar"></div><div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                </div>
                
                <div id="status-log" class="status-log">æº–å‚™å°±ç·’<br>è«‹æŒ‰éº¥å…‹é¢¨æŒ‰éˆ•</div>
                <button id="mic-btn" class="mic-btn" onclick="toggleSpeech()">ğŸ¤</button>
                <input type="text" id="text-input" style="display:none;" placeholder="è¼¸å…¥ç¾…é¦¬æ‹¼éŸ³" autocomplete="off">
            </div>
        </div>

        <div id="result-view">
            <h2 style="color:var(--primary-dark); margin-bottom:15px;">ğŸŒ¸ ç·´ç¿’å®Œæˆ ğŸŒ¸</h2>
            <div class="score-circle">
                <span style="font-size:2.5rem; font-weight:bold;" id="final-score">0</span>
                <span style="font-size:0.8rem;">æœ€çµ‚å¾—åˆ†</span>
            </div>
            <div class="ranking-list" id="ranking-container"></div>
            <button class="btn-action" onclick="restartSession()">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>

    <script>
        // --- æ«»èŠ±ç‰¹æ•ˆ (é«˜å¯†åº¦) ---
        function createSakura() {
            const c = document.getElementById('sakura-container');
            const p = document.createElement('div'); p.className = 'petal';
            const size = Math.random()*12+8;
            p.style.left = Math.random()*window.innerWidth+'px';
            p.style.width = size+'px'; p.style.height = size+'px';
            p.style.animationDuration = (Math.random()*5+4)+'s';
            c.appendChild(p); setTimeout(()=>p.remove(), 9000);
        }
        setInterval(createSakura, 100);

        // --- æ ¸å¿ƒé‚è¼¯èˆ‡ç‹€æ…‹ ---
        const gojuonDB = { seion:[{r:'a',h:'ã‚',k:'ã‚¢'},{r:'i',h:'ã„',k:'ã‚¤'},{r:'u',h:'ã†',k:'ã‚¦'},{r:'e',h:'ãˆ',k:'ã‚¨'},{r:'o',h:'ãŠ',k:'ã‚ª'},{r:'ka',h:'ã‹',k:'ã‚«'},{r:'ki',h:'ã',k:'ã‚­'},{r:'ku',h:'ã',k:'ã‚¯'},{r:'ke',h:'ã‘',k:'ã‚±'},{r:'ko',h:'ã“',k:'ã‚³'},{r:'sa',h:'ã•',k:'ã‚µ'},{r:'shi',h:'ã—',k:'ã‚·'},{r:'su',h:'ã™',k:'ã‚¹'},{r:'se',h:'ã›',k:'ã‚»'},{r:'so',h:'ã',k:'ã‚½'},{r:'ta',h:'ãŸ',k:'ã‚¿'},{r:'chi',h:'ã¡',k:'ãƒ'},{r:'tsu',h:'ã¤',k:'ãƒ„'},{r:'te',h:'ã¦',k:'ãƒ†'},{r:'to',h:'ã¨',k:'ãƒˆ'},{r:'na',h:'ãª',k:'ãƒŠ'},{r:'ni',h:'ã«',k:'ãƒ‹'},{r:'nu',h:'ã¬',k:'ãƒŒ'},{r:'ne',h:'ã­',k:'ãƒ'},{r:'no',h:'ã®',k:'ãƒ'},{r:'ha',h:'ã¯',k:'ãƒ'},{r:'hi',h:'ã²',k:'ãƒ’'},{r:'fu',h:'ãµ',k:'ãƒ•'},{r:'he',h:'ã¸',k:'ãƒ˜'},{r:'ho',h:'ã»',k:'ãƒ›'},{r:'ma',h:'ã¾',k:'ãƒ'},{r:'mi',h:'ã¿',k:'ãƒŸ'},{r:'mu',h:'ã‚€',k:'ãƒ '},{r:'me',h:'ã‚',k:'ãƒ¡'},{r:'mo',h:'ã‚‚',k:'ãƒ¢'},{r:'ya',h:'ã‚„',k:'ãƒ¤'},{r:'yu',h:'ã‚†',k:'ãƒ¦'},{r:'yo',h:'ã‚ˆ',k:'ãƒ¨'},{r:'ra',h:'ã‚‰',k:'ãƒ©'},{r:'ri',h:'ã‚Š',k:'ãƒª'},{r:'ru',h:'ã‚‹',k:'ãƒ«'},{r:'re',h:'ã‚Œ',k:'ãƒ¬'},{r:'ro',h:'ã‚',k:'ãƒ­'},{r:'wa',h:'ã‚',k:'ãƒ¯'},{r:'wo',h:'ã‚’',k:'ãƒ²'},{r:'n',h:'ã‚“',k:'ãƒ³'}], dakuon:[{r:'ga',h:'ãŒ',k:'ã‚¬'},{r:'gi',h:'ã',k:'ã‚®'},{r:'gu',h:'ã',k:'ã‚°'},{r:'ge',h:'ã’',k:'ã‚²'},{r:'go',h:'ã”',k:'ã‚´'},{r:'za',h:'ã–',k:'ã‚¶'},{r:'ji',h:'ã˜',k:'ã‚¸'},{r:'zu',h:'ãš',k:'ã‚º'},{r:'ze',h:'ãœ',k:'ã‚¼'},{r:'zo',h:'ã',k:'ã‚¾'},{r:'da',h:'ã ',k:'ãƒ€'},{r:'ji',h:'ã¢',k:'ãƒ‚'},{r:'zu',h:'ã¥',k:'ãƒ…'},{r:'de',h:'de',k:'ãƒ‡'},{r:'do',h:'ã©',k:'ãƒ‰'},{r:'ba',h:'ã°',k:'ãƒ'},{r:'bi',h:'ã³',k:'ãƒ“'},{r:'bu',h:'ã¶',k:'ãƒ–'},{r:'be',h:'ã¹',k:'ãƒ™'},{r:'bo',h:'ã¼',k:'ãƒœ'}], handakuon:[{r:'pa',h:'ã±',k:'ãƒ‘'},{r:'pi',h:'ã´',k:'ãƒ”'},{r:'pu',h:'ã·',k:'ãƒ—'},{r:'pe',h:'ãº',k:'ãƒš'},{r:'po',h:'ã½',k:'ãƒ'}], yoon:[{r:'kya',h:'ãã‚ƒ',k:'ã‚­ãƒ£'},{r:'kyu',h:'ãã‚…',k:'ã‚­ãƒ¥'},{r:'kyo',h:'ãã‚‡',k:'ã‚­ãƒ§'},{r:'sha',h:'ã—ã‚ƒ',k:'ã‚·ãƒ£'},{r:'shu',h:'ã—ã‚…',k:'ã‚·ãƒ¥'},{r:'sho',h:'ã—ã‚‡',k:'ã‚·ãƒ§'},{r:'cha',h:'ã¡ã‚ƒ',k:'ãƒãƒ£'},{r:'chu',h:'ã¡ã‚…',k:'ãƒãƒ¥'},{r:'cho',h:'ã¡ã‚‡',k:'ãƒãƒ§'},{r:'nya',h:'ã«ã‚ƒ',k:'ãƒ‹ãƒ£'},{r:'nyu',h:'ã«ã‚…',k:'ãƒ‹ãƒ¥'},{r:'nyo',h:'ã«ã‚‡',k:'ãƒ‹ãƒ§'},{r:'hya',h:'ã²ã‚ƒ',k:'ãƒ’ãƒ£'},{r:'hyu',h:'ã²ã‚…',k:'ãƒ’ãƒ¥'},{r:'hyo',h:'ã²ã‚‡',k:'ãƒ’ãƒ§'},{r:'mya',h:'ã¿ã‚ƒ',k:'ãƒŸãƒ£'},{r:'myu',h:'ã¿ã‚…',k:'ãƒŸãƒ¥'},{r:'myo',h:'ã¿ã‚‡',k:'ãƒŸãƒ§'},{r:'rya',h:'ã‚Šã‚ƒ',k:'ãƒªãƒ£'},{r:'ryu',h:'ã‚Šã‚…',k:'ãƒªãƒ¥'},{r:'ryo',h:'ã‚Šã‚‡',k:'ãƒªãƒ§'},{r:'gya',h:'ãã‚ƒ',k:'ã‚®ãƒ£'},{r:'gyu',h:'ãã‚…',k:'ã‚®ãƒ¥'},{r:'gyo',h:'ãã‚‡',k:'ã‚®ãƒ§'},{r:'ja',h:'ã˜ã‚ƒ',k:'ã‚¸ãƒ£'},{r:'ju',h:'ã˜ã‚…',k:'ã‚¸ãƒ¥'},{r:'jo',h:'ã˜ã‚‡',k:'ã‚¸ãƒ§'},{r:'bya',h:'ã³ã‚ƒ',k:'ãƒ“ãƒ£'},{r:'byu',h:'ã³ã‚…',k:'ãƒ“ãƒ¥'},{r:'byo',h:'ã³ã‚‡',k:'ãƒ“ãƒ§'},{r:'pya',h:'ã´ã‚ƒ',k:'ãƒ”ãƒ£'},{r:'pyu',h:'ã´ã‚…',k:'ãƒ”ãƒ¥'},{r:'pyo',h:'ã´ã‚‡',k:'ãƒ”ãƒ§'}] };

        const QUESTIONS_LIMIT = 25;
        let sessionData = { count: 0, correct: 0 };
        let state = { category: 'seion', kanaType: 'h', inputMode: 'voice', currentCard: null, pool: [] };
        let globalMistakes = JSON.parse(localStorage.getItem('gojuon_sakura_mistakes_v3')) || {};
        let recognition = null;
        let isListening = false;
        
        // Audio Context (Visualizer + iOS Wakeup)
        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;

        // TTS Voices
        let voices = [];
        const synth = window.speechSynthesis;

        // --- 1. èªéŸ³åˆæˆ (TTS) å„ªåŒ–ï¼šç™¼éŸ³äººé¸æ“‡ ---
        function populateVoiceList() {
            voices = synth.getVoices().sort((a, b) => {
                const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
                if ( aname < bname ) return -1;
                else if ( aname == bname ) return 0;
                return +1;
            });

            const select = document.getElementById("voice-select");
            select.innerHTML = '';

            // å„ªå…ˆå°‹æ‰¾æ—¥èªç™¼éŸ³
            let defaultIndex = 0;
            // éæ¿¾åªé¡¯ç¤ºæ—¥èªç›¸é—œï¼Œæˆ–è€…ä¸»è¦çš„å¹¾å€‹
            const jaVoices = voices.filter(v => v.lang.includes('ja') || v.lang.includes('JP'));
            
            if(jaVoices.length === 0) {
                 // å¦‚æœæ²’æœ‰æ—¥èªï¼Œé¡¯ç¤ºå…¨éƒ¨
                 voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = index; // Store original index
                    select.appendChild(option);
                 });
            } else {
                jaVoices.forEach((voice) => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name}`;
                    // Find original index
                    const originalIndex = voices.indexOf(voice);
                    option.value = originalIndex;
                    if(voice.default) defaultIndex = originalIndex;
                    select.appendChild(option);
                });
            }
            // å˜—è©¦é¸ä¸­ Google æ—¥æœ¬èª æˆ– ç³»çµ±é è¨­
            const googleJa = voices.findIndex(v => v.name.includes("Google") && v.lang.includes("ja"));
            if(googleJa !== -1) select.value = googleJa;
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function playAudio(isTest = false) {
            if(!state.currentCard && !isTest) return;
            synth.cancel(); // åœæ­¢ç•¶å‰
            
            const text = isTest ? "ã“ã‚“ã«ã¡ã¯" : state.currentCard.h;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 0.9; // ç¨å¾®æ…¢ä¸€é»é©åˆå­¸ç¿’

            const select = document.getElementById("voice-select");
            if(select.value) {
                u.voice = voices[select.value];
            }

            synth.speak(u);
        }

        // --- 2. éº¥å…‹é¢¨èˆ‡è¦–è¦ºåŒ– (Visualizer) ---
        function startVisualizer(stream) {
            if(audioContext) { audioContext.close(); } // Reset
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(1024, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 512;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            const bars = document.querySelectorAll('.visualizer-bar');
            const container = document.getElementById('visualizer');
            
            javascriptNode.onaudioprocess = function() {
                var array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                var values = 0;
                var length = array.length;
                for (var i = 0; i < length; i++) values += array[i];
                var average = values / length;

                // è¦–è¦ºåŒ–é‚è¼¯ï¼šå¦‚æœæœ‰è²éŸ³ï¼Œaverage æœƒå¤§æ–¼ 10~20
                if (average > 10) container.classList.add('active');
                else container.classList.remove('active');

                bars.forEach((bar, index) => {
                    // ç°¡å–®çš„æ³¢å½¢æ¨¡æ“¬
                    let h = Math.max(4, average * (1 + Math.random()));
                    bar.style.height = Math.min(h, 20) + 'px'; 
                });
            }
        }

        function stopVisualizer() {
            if(javascriptNode) javascriptNode.disconnect();
            if(microphone) microphone.disconnect();
            if(analyser) analyser.disconnect();
            // Don't close context immediately to avoid lag on restart
            document.getElementById('visualizer').classList.remove('active');
            document.querySelectorAll('.visualizer-bar').forEach(b => b.style.height = '4px');
        }

        // --- 3. èªéŸ³è­˜åˆ¥æ ¸å¿ƒ (SpeechRecognition) ---
        function initSpeech() {
            // æª¢æŸ¥ Line/FB å…§å»ºç€è¦½å™¨ (é€šå¸¸ä¸æ”¯æ´)
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/Line|FBAN|FBAV|Instagram/.test(userAgent)) {
                logStatus("âŒ è«‹é»é¸å³ä¸Šè§’ï¼Œæ›æˆ Chrome æˆ– Safari é–‹å•Ÿ");
                return;
            }

            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // åš´æ ¼éµå®ˆå„ªåŒ–è¦æ±‚ï¼š
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = true; // é—œéµï¼šå³æ™‚å›é¥‹
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('mic-btn').classList.add('listening');
                    logStatus("ğŸ‘‚ è†è½ä¸­...è«‹çœ‹ä¸Šæ–¹ç¶ æ¢æ˜¯å¦æœ‰è·³å‹•");
                    
                    // å•Ÿå‹• Visualizer ä¸²æµ
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => startVisualizer(stream))
                        .catch(e => console.error("Mic Visualizer Error", e));
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('mic-btn').classList.remove('listening');
                    stopVisualizer();
                    // å»¶é²åˆ¤æ–·æ˜¯å¦å®Œå…¨æ²’è²éŸ³
                    setTimeout(() => {
                        const txt = document.getElementById('status-log').innerText;
                        if(txt.includes("è†è½ä¸­")) {
                            logStatus("âŒ æœªæª¢æ¸¬åˆ°èªéŸ³ (è«‹é è¿‘è©±ç­’)");
                        }
                    }, 300);
                };

                recognition.onresult = (event) => {
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            checkAnswer(event.results[i][0].transcript);
                        } else {
                            interim += event.results[i][0].transcript;
                            logStatus(`... ${interim}`); // é¡¯ç¤ºæ­£åœ¨è½åˆ°çš„å…§å®¹
                        }
                    }
                };

                recognition.onerror = (event) => {
                    isListening = false;
                    stopVisualizer();
                    document.getElementById('mic-btn').classList.remove('listening');
                    if (event.error === 'no-speech') logStatus("âŒ æ²’è½åˆ°è²éŸ³");
                    else if (event.error === 'not-allowed') logStatus("â›” éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’");
                    else logStatus("âš ï¸ éŒ¯èª¤: " + event.error);
                };
            } else {
                alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ï¼Œè«‹ä½¿ç”¨ Chrome/Safari");
            }
        }

        function toggleSpeech() {
            if(!recognition) initSpeech();