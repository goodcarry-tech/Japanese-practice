<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥èªäº”åéŸ³ï¼šæ«»èŠ±èªé€Ÿç‰¹è¨“ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap');

        :root {
            --primary: #ff9a9e;
            --primary-dark: #e84393;
            --text: #2d3436;
            --glass: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.6);
            --success: #00b894;
            --error: #ff7675;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            overflow: hidden;
            /* 4K é«˜ç•«è³ªæ«»èŠ±èƒŒæ™¯ */
            background: url('https://images.unsplash.com/photo-1522383225653-ed111181a951?q=100&w=3200&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
        }

        /* ğŸŒ¸ æ«»èŠ±ç‰¹æ•ˆ */
        #sakura-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .petal {
            position: absolute;
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 150% 0 150% 0;
            animation: fall linear infinite;
            opacity: 0.9;
            box-shadow: 0 0 5px rgba(255, 154, 158, 0.5);
        }

        @keyframes fall {
            0% { opacity: 0; transform: translate(0, -10vh) rotate(0deg) rotateX(0deg); }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translate(100px, 110vh) rotate(720deg) rotateX(180deg); }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            position: relative;
            z-index: 10;
            background: var(--glass);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        /* ä»‹é¢å…ƒä»¶ */
        .header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; border-bottom: 2px dashed #ffc3a0; padding-bottom: 10px;
        }
        h1 { font-size: 1.5rem; margin: 0; color: var(--primary-dark); text-shadow: 1px 1px 0 #fff; }
        
        .progress-badge {
            background: linear-gradient(to right, #ff9a9e, #fecfef);
            color: white; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9rem;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; align-items: center; }
        
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; width: 100%; justify-content: center; padding-bottom: 5px; }
        .chip { padding: 6px 14px; border-radius: 20px; background: white; border: 1px solid #ffc3a0; color: var(--text); font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* èªé€Ÿæ§åˆ¶å€ */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            width: 80%;
            justify-content: center;
            color: #636e72;
            font-size: 0.9rem;
            border: 1px solid #ffeaa7;
        }
        
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #ffeaa7; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; 
            background: var(--primary); cursor: pointer; transition: .2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .toggle-group { display: flex; gap: 10px; background: white; padding: 4px 12px; border-radius: 20px; border: 1px solid #ffc3a0; }
        .mode-btn { background: none; border: none; color: #b2bec3; cursor: pointer; font-weight: bold; font-size: 0.85rem; padding: 4px 8px; border-radius: 12px; transition: 0.3s; }
        .mode-btn.active { background: var(--primary-dark); color: white; }

        /* å¡ç‰‡ */
        .flashcard {
            width: 200px; height: 220px; background: white; border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(255, 154, 158, 0.3); border: 4px solid white;
            cursor: pointer; transition: transform 0.3s; margin-bottom: 20px;
        }
        .flashcard:hover { transform: translateY(-5px); border-color: #ffeaa7; }
        .flashcard.wrong-shake { border-color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        .kana-char { font-size: 5rem; font-weight: 700; color: var(--text); line-height: 1; }
        .romaji-hint { font-size: 1.2rem; color: #fab1a0; margin-top: 10px; opacity: 0; transition: 0.3s; }
        .flashcard:hover .romaji-hint { opacity: 1; }

        .input-section { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .status-log { font-size: 0.9rem; color: var(--primary-dark); min-height: 1.4rem; margin-bottom: 10px; font-weight: 500; background: rgba(255,255,255,0.6); padding: 2px 10px; border-radius: 8px; }
        
        .mic-btn { width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border: none; color: white; font-size: 1.6rem; cursor: pointer; box-shadow: 0 5px 15px rgba(255, 154, 158, 0.6); display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .mic-btn:hover { transform: scale(1.1); }
        .mic-btn.listening { background: var(--error); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,118,117,0.7);} 70% {box-shadow: 0 0 0 15px rgba(0,0,0,0);} 100% {box-shadow: 0 0 0 0 rgba(0,0,0,0);} }

        input[type="text"] { width: 220px; padding: 10px 20px; font-size: 1.2rem; border: 2px solid #ffc3a0; border-radius: 50px; text-align: center; outline: none; transition: 0.3s; font-family: 'Zen Maru Gothic', sans-serif; }
        input[type="text"]:focus { box-shadow: 0 0 0 4px rgba(255, 154, 158, 0.3); border-color: var(--primary); }

        #result-view { display: none; width: 100%; text-align: center; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: white; border: 4px solid #ff9a9e; margin: 0 auto 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--primary-dark); }
        .ranking-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding: 5px; }
        .rank-item { background: white; padding: 8px 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-action { width: 100%; margin-top: 15px; padding: 12px; border: none; border-radius: 50px; background: var(--primary-dark); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <!-- æ«»èŠ±ç‰¹æ•ˆ -->
    <div id="sakura-container"></div>

    <div class="container">
        <!-- ç·´ç¿’æ¨¡å¼ -->
        <div id="practice-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="header">
                <h1>æ«»èŠ±ç‰¹è¨“ ğŸŒ¸</h1>
                <div class="progress-badge" id="progress-text">1 / 25</div>
            </div>

            <div class="control-panel">
                <div class="category-scroll">
                    <div class="chip active" onclick="setCategory('seion', this)">æ¸…éŸ³</div>
                    <div class="chip" onclick="setCategory('dakuon', this)">æ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('handakuon', this)">åŠæ¿éŸ³</div>
                    <div class="chip" onclick="setCategory('yoon', this)">æ‹—éŸ³</div>
                    <div class="chip" onclick="setCategory('all', this)">å…¨éƒ¨</div>
                </div>

                <!-- èªé€Ÿæ§åˆ¶å™¨ -->
                <div class="speed-control">
                    <span>ğŸ¢</span>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" oninput="updateSpeed(this.value)">
                    <span id="speed-display" style="font-weight:bold; width:40px;">1.0x</span>
                    <span>ğŸ°</span>
                </div>

                <div class="toggle-group">
                    <button class="mode-btn active" id="btn-voice" onclick="setInputMode('voice')">ğŸ¤ èªéŸ³</button>
                    <button class="mode-btn" id="btn-type" onclick="setInputMode('type')">âŒ¨ï¸ æ‰“å­—</button>
                    <span>|</span>
                    <button class="mode-btn active" onclick="setKana('h', this)">å¹³å‡å</button>
                    <button class="mode-btn" onclick="setKana('k', this)">ç‰‡å‡å</button>
                </div>
            </div>

            <div class="flashcard" id="flashcard" onclick="playAudio()">
                <div class="kana-char" id="kana-display">ã‚</div>
                <div class="romaji-hint" id="romaji-hint">a</div>
                <div style="font-size: 0.75rem; color: #b2bec3; position: absolute; bottom: 15px;">é»æ“Šæ’­æ”¾ç™¼éŸ³ ğŸ”Š</div>
            </div>

            <div class="input-section">
                <div id="status-log" class="status-log">é»æ“Šéº¥å…‹é¢¨é–‹å§‹</div>
                <button id="mic-btn" class="mic-btn" onclick="toggleSpeech()">ğŸ¤</button>
                <input type="text" id="text-input" style="display:none;" placeholder="è¼¸å…¥ç­”æ¡ˆ (å¦‚: a)" autocomplete="off">
            </div>
        </div>

        <!-- çµç®—æ¨¡å¼ -->
        <div id="result-view">
            <h2 style="color:var(--primary-dark); margin-bottom:15px;">ğŸŒ¸ ç·´ç¿’å®Œæˆ ğŸŒ¸</h2>
            <div class="score-circle">
                <span style="font-size:2.5rem; font-weight:bold;" id="final-score">0</span>
                <span style="font-size:0.8rem;">æœ€çµ‚å¾—åˆ†</span>
            </div>
            <div style="text-align:left; width:100%; margin-bottom:8px; font-weight:bold; color:#636e72;">
                ğŸ”¥ éŒ¯é¡Œæ’è¡Œæ¦œ
            </div>
            <div class="ranking-list" id="ranking-container"></div>
            <button class="btn-action" onclick="restartSession()">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>

    <script>
        // --- ğŸŒ¸ æ«»èŠ±åŠ é‡ç‰ˆ (3x æ•¸é‡) ---
        function createSakura() {
            const container = document.getElementById('sakura-container');
            const petal = document.createElement('div');
            petal.className = 'petal';
            const startLeft = Math.random() * window.innerWidth;
            const size = Math.random() * 12 + 6; 
            const duration = Math.random() * 5 + 5; 
            
            petal.style.left = startLeft + 'px';
            petal.style.width = size + 'px';
            petal.style.height = size + 'px';
            petal.style.animationDuration = duration + 's';
            container.appendChild(petal);
            setTimeout(() => { petal.remove(); }, duration * 1000);
        }
        setInterval(createSakura, 80); // 80ms ç”Ÿæˆä¸€ç‰‡

        // --- ğŸ® éŠæˆ²é‚è¼¯ ---
        const gojuonDB = {
            seion: [
                { r: 'a', h: 'ã‚', k: 'ã‚¢' }, { r: 'i', h: 'ã„', k: 'ã‚¤' }, { r: 'u', h: 'ã†', k: 'ã‚¦' }, { r: 'e', h: 'ãˆ', k: 'ã‚¨' }, { r: 'o', h: 'ãŠ', k: 'ã‚ª' },
                { r: 'ka', h: 'ã‹', k: 'ã‚«' }, { r: 'ki', h: 'ã', k: 'ã‚­' }, { r: 'ku', h: 'ã', k: 'ã‚¯' }, { r: 'ke', h: 'ã‘', k: 'ã‚±' }, { r: 'ko', h: 'ã“', k: 'ã‚³' },
                { r: 'sa', h: 'ã•', k: 'ã‚µ' }, { r: 'shi', h: 'ã—', k: 'ã‚·' }, { r: 'su', h: 'ã™', k: 'ã‚¹' }, { r: 'se', h: 'ã›', k: 'ã‚»' }, { r: 'so', h: 'ã', k: 'ã‚½' },
                { r: 'ta', h: 'ãŸ', k: 'ã‚¿' }, { r: 'chi', h: 'ã¡', k: 'ãƒ' }, { r: 'tsu', h: 'ã¤', k: 'ãƒ„' }, { r: 'te', h: 'ã¦', k: 'ãƒ†' }, { r: 'to', h: 'ã¨', k: 'ãƒˆ' },
                { r: 'na', h: 'ãª', k: 'ãƒŠ' }, { r: 'ni', h: 'ã«', k: 'ãƒ‹' }, { r: 'nu', h: 'ã¬', k: 'ãƒŒ' }, { r: 'ne', h: 'ã­', k: 'ãƒ' }, { r: 'no', h: 'ã®', k: 'ãƒ' },
                { r: 'ha', h: 'ã¯', k: 'ãƒ' }, { r: 'hi', h: 'ã²', k: 'ãƒ’' }, { r: 'fu', h: 'ãµ', k: 'ãƒ•' }, { r: 'he', h: 'ã¸', k: 'ãƒ˜' }, { r: 'ho', h: 'ã»', k: 'ãƒ›' },
                { r: 'ma', h: 'ã¾', k: 'ãƒ' }, { r: 'mi', h: 'ã¿', k: 'ãƒŸ' }, { r: 'mu', h: 'ã‚€', k: 'ãƒ ' }, { r: 'me', h: 'ã‚', k: 'ãƒ¡' }, { r: 'mo', h: 'ã‚‚', k: 'ãƒ¢' },
                { r: 'ya', h: 'ã‚„', k: 'ãƒ¤' }, { r: 'yu', h: 'ã‚†', k: 'ãƒ¦' }, { r: 'yo', h: 'ã‚ˆ', k: 'ãƒ¨' },
                { r: 'ra', h: 'ã‚‰', k: 'ãƒ©' }, { r: 'ri', h: 'ã‚Š', k: 'ãƒª' }, { r: 'ru', h: 'ã‚‹', k: 'ãƒ«' }, { r: 're', h: 'ã‚Œ', k: 'ãƒ¬' }, { r: 'ro', h: 'ã‚', k: 'ãƒ­' },
                { r: 'wa', h: 'ã‚', k: 'ãƒ¯' }, { r: 'wo', h: 'ã‚’', k: 'ãƒ²' }, { r: 'n', h: 'ã‚“', k: 'ãƒ³' }
            ],
            dakuon: [
                { r: 'ga', h: 'ãŒ', k: 'ã‚¬' }, { r: 'gi', h: 'ã', k: 'ã‚®' }, { r: 'gu', h: 'ã', k: 'ã‚°' }, { r: 'ge', h: 'ã’', k: 'ã‚²' }, { r: 'go', h: 'ã”', k: 'ã‚´' },
                { r: 'za', h: 'ã–', k: 'ã‚¶' }, { r: 'ji', h: 'ã˜', k: 'ã‚¸' }, { r: 'zu', h: 'ãš', k: 'ã‚º' }, { r: 'ze', h: 'ãœ', k: 'ã‚¼' }, { r: 'zo', h: 'ã', k: 'ã‚¾' },
                { r: 'da', h: 'ã ', k: 'ãƒ€' }, { r: 'ji', h: 'ã¢', k: 'ãƒ‚' }, { r: 'zu', h: 'ã¥', k: 'ãƒ…' }, { r: 'de', h: 'ã§', k: 'ãƒ‡' }, { r: 'do', h: 'ã©', k: 'ãƒ‰' },
                { r: 'ba', h: 'ã°', k: 'ãƒ' }, { r: 'bi', h: 'ã³', k: 'ãƒ“' }, { r: 'bu', h: 'ã¶', k: 'ãƒ–' }, { r: 'be', h: 'ã¹', k: 'ãƒ™' }, { r: 'bo', h: 'ã¼', k: 'ãƒœ' }
            ],
            handakuon: [
                { r: 'pa', h: 'ã±', k: 'ãƒ‘' }, { r: 'pi', h: 'ã´', k: 'ãƒ”' }, { r: 'pu', h: 'ã·', k: 'ãƒ—' }, { r: 'pe', h: 'ãº', k: 'ãƒš' }, { r: 'po', h: 'ã½', k: 'ãƒ' }
            ],
            yoon: [
                { r: 'kya', h: 'ãã‚ƒ', k: 'ã‚­ãƒ£' }, { r: 'kyu', h: 'ãã‚…', k: 'ã‚­ãƒ¥' }, { r: 'kyo', h: 'ãã‚‡', k: 'ã‚­ãƒ§' },
                { r: 'sha', h: 'ã—ã‚ƒ', k: 'ã‚·ãƒ£' }, { r: 'shu', h: 'ã—ã‚…', k: 'ã‚·ãƒ¥' }, { r: 'sho', h: 'ã—ã‚‡', k: 'ã‚·ãƒ§' },
                { r: 'cha', h: 'ã¡ã‚ƒ', k: 'ãƒãƒ£' }, { r: 'chu', h: 'ã¡ã‚…', k: 'ãƒãƒ¥' }, { r: 'cho', h: 'ã¡ã‚‡', k: 'ãƒãƒ§' },
                { r: 'nya', h: 'ã«ã‚ƒ', k: 'ãƒ‹ãƒ£' }, { r: 'nyu', h: 'ã«ã‚…', k: 'ãƒ‹ãƒ¥' }, { r: 'nyo', h: 'ã«ã‚‡', k: 'ãƒ‹ãƒ§' },
                { r: 'hya', h: 'ã²ã‚ƒ', k: 'ãƒ’ãƒ£' }, { r: 'hyu', h: 'ã²ã‚…', k: 'ãƒ’ãƒ¥' }, { r: 'hyo', h: 'ã²ã‚‡', k: 'ãƒ’ãƒ§' },
                { r: 'mya', h: 'ã¿ã‚ƒ', k: 'ãƒŸãƒ£' }, { r: 'myu', h: 'ã¿ã‚…', k: 'ãƒŸãƒ¥' }, { r: 'myo', h: 'ã¿ã‚‡', k: 'ãƒŸãƒ§' },
                { r: 'rya', h: 'ã‚Šã‚ƒ', k: 'ãƒªãƒ£' }, { r: 'ryu', h: 'ã‚Šã‚…', k: 'ãƒªãƒ¥' }, { r: 'ryo', h: 'ã‚Šã‚‡', k: 'ãƒªãƒ§' },
                { r: 'gya', h: 'ãã‚ƒ', k: 'ã‚®ãƒ£' }, { r: 'gyu', h: 'ãã‚…', k: 'ã‚®ãƒ¥' }, { r: 'gyo', h: 'ãã‚‡', k: 'ã‚®ãƒ§' },
                { r: 'ja', h: 'ã˜ã‚ƒ', k: 'ã‚¸ãƒ£' }, { r: 'ju', h: 'ã˜ã‚…', k: 'ã‚¸ãƒ¥' }, { r: 'jo', h: 'ã˜ã‚‡', k: 'ã‚¸ãƒ§' },
                { r: 'bya', h: 'ã³ã‚ƒ', k: 'ãƒ“ãƒ£' }, { r: 'byu', h: 'ã³ã‚…', k: 'ãƒ“ãƒ¥' }, { r: 'byo', h: 'ã³ã‚‡', k: 'ãƒ“ãƒ§' },
                { r: 'pya', h: 'ã´ã‚ƒ', k: 'ãƒ”ãƒ£' }, { r: 'pyu', h: 'ã´ã‚…', k: 'ãƒ”ãƒ¥' }, { r: 'pyo', h: 'ã´ã‚‡', k: 'ãƒ”ãƒ§' }
            ]
        };

        const QUESTIONS_LIMIT = 25;
        let sessionData = { count: 0, correct: 0 };
        let state = { category: 'seion', kanaType: 'h', inputMode: 'voice', currentCard: null, pool: [] };
        let globalMistakes = JSON.parse(localStorage.getItem('gojuon_sakura_mistakes_v2')) || {};
        let recognition = null;
        let isListening = false;
        let speechRate = 1.0; // èªé€Ÿç‹€æ…‹

        window.onload = function() {
            initPool();
            initSpeech();
            nextQuestion();
        };

        function initPool() {
            if(state.category === 'all') {
                state.pool = [...gojuonDB.seion, ...gojuonDB.dakuon, ...gojuonDB.handakuon, ...gojuonDB.yoon];
            } else {
                state.pool = gojuonDB[state.category];
            }
        }

        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('mic-btn').classList.add('listening');
                    logStatus("ğŸŒ¸ è†è½ä¸­...");
                };
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('mic-btn').classList.remove('listening');
                };
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    checkAnswer(transcript);
                };
            }
        }

        function toggleSpeech() {
            if(!recognition) return alert("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨");
            if(isListening) recognition.stop();
            else recognition.start();
        }

        // æ›´æ–°èªé€Ÿ
        function updateSpeed(val) {
            speechRate = parseFloat(val);
            document.getElementById('speed-display').innerText = speechRate + 'x';
        }

        // æ’­æ”¾éŸ³é » (æ”¯æ´èªé€Ÿ)
        function playAudio() {
            if(!state.currentCard) return;
            window.speechSynthesis.cancel(); // åœæ­¢ç•¶å‰ç™¼éŸ³
            const u = new SpeechSynthesisUtterance(state.currentCard.h);
            u.lang = 'ja-JP';
            u.rate = speechRate; // æ‡‰ç”¨èªé€Ÿ
            window.speechSynthesis.speak(u);
        }

        function logStatus(msg) { document.getElementById('status-log').innerText = msg; }

        function setCategory(cat, btn) {
            state.category = cat;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            restartSession();
        }

        function setInputMode(mode) {
            state.inputMode = mode;
            document.getElementById('btn-voice').className = mode === 'voice' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btn-type').className = mode === 'type' ? 'mode-btn active' : 'mode-btn';
            const mic = document.getElementById('mic-btn');
            const input = document.getElementById('text-input');

            if(mode === 'type') {
                mic.style.display = 'none'; input.style.display = 'block'; input.focus();
                logStatus("âŒ¨ï¸ è¼¸å…¥å¾ŒæŒ‰ Enter");
            } else {
                mic.style.display = 'flex'; input.style.display = 'none';
                logStatus("ğŸŒ¸ é»æ“Šéº¥å…‹é¢¨é–‹å§‹");
            }
        }

        function setKana(type, btn) {
            state.kanaType = type;
            btn.parentElement.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateCardUI();
        }

        function nextQuestion() {
            if (sessionData.count >= QUESTIONS_LIMIT) {
                showResults();
                return;
            }
            sessionData.count++;
            document.getElementById('progress-text').innerText = `${sessionData.count} / ${QUESTIONS_LIMIT}`;
            const rand = Math.floor(Math.random() * state.pool.length);
            state.currentCard = state.pool[rand];
            updateCardUI();
            document.getElementById('flashcard').classList.remove('wrong-shake');
            document.getElementById('text-input').value = '';
        }

        function updateCardUI() {
            if(!state.currentCard) return;
            const char = state.kanaType === 'h' ? state.currentCard.h : state.currentCard.k;
            const div = document.getElementById('kana-display');
            div.innerText = char;
            div.style.fontSize = char.length > 1 ? '4rem' : '6rem';
            document.getElementById('romaji-hint').innerText = state.currentCard.r;
        }

        function checkAnswer(inputRaw) {
            const input = inputRaw.toLowerCase().replace(/[.ã€‚\s]/g, '').trim();
            const target = state.currentCard;
            let isCorrect = false;

            if (state.inputMode === 'voice') {
                isCorrect = (input === target.h || input === target.k || input === target.r || input === target.r.replace('fu', 'hu'));
            } else {
                isCorrect = (input === target.r);
            }

            if (isCorrect) {
                sessionData.correct++;
                logStatus("âœ… æ­£ç¢ºï¼");
                playAudio();
                setTimeout(nextQuestion, 800);
            } else {
                logStatus(`âŒ ç­”æ¡ˆæ˜¯ ${target.r}`);
                document.getElementById('flashcard').classList.add('wrong-shake');
                recordMistake(target);
                setTimeout(nextQuestion, 1500);
            }
        }

        document.getElementById('text-input').addEventListener('keyup', (e) => {
            if(e.key === 'Enter') checkAnswer(e.target.value);
        });

        function recordMistake(card) {
            const key = card.r;
            if (!globalMistakes[key]) globalMistakes[key] = { count: 0, char: card.h, romaji: card.r };
            globalMistakes[key].count++;
            localStorage.setItem('gojuon_sakura_mistakes_v2', JSON.stringify(globalMistakes));
        }

        function showResults() {
            document.getElementById('practice-view').style.display = 'none';
            document.getElementById('result-view').style.display = 'block';
            const score = Math.round((sessionData.correct / QUESTIONS_LIMIT) * 100);
            document.getElementById('final-score').innerText = score;
            renderRanking();
        }

        function renderRanking() {
            const container = document.getElementById('ranking-container');
            container.innerHTML = '';
            const sorted = Object.values(globalMistakes).sort((a, b) => b.count - a.count).slice(0, 20);

            if (sorted.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#b2bec3;">ğŸŒ¸ å®Œç¾ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œè¨˜éŒ„</div>';
                return;
            }
            sorted.forEach((item) => {
                const html = `
                    <div class="rank-item">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:1.2rem; font-weight:bold;">${item.char}</span>
                            <span style="color:#b2bec3; font-size:0.9rem;">${item.romaji}</span>
                        </div>
                        <span style="background:#ffeaa7; padding:2px 8px; border-radius:10px; font-size:0.8rem; color:#d35400;">${item.count}æ¬¡</span>
                    </div>`;
                container.innerHTML += html;
            });
        }

        function restartSession() {
            sessionData = { count: 0, correct: 0 };
            initPool();
            document.getElementById('practice-view').style.display = 'flex';
            document.getElementById('result-view').style.display = 'none';
            nextQuestion();
        }
    </script>
</body>
</html>