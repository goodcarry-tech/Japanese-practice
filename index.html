<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff9a9e">
    <title>æ—¥èªäº”åéŸ³ï¼šæ™ºèƒ½èªéŸ³ç‰ˆ</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/144/sakura.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap');

        :root {
            --primary: #ff85a2;
            --primary-dark: #e84393;
            --text: #2d3436;
            --card-bg: rgba(255, 255, 255, 0.93);
            --success: #00b894;
            --error: #ff7675;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            margin: 0;
            min-height: 100dvh; /* æ‰‹æ©Ÿå®Œç¾é«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            overflow: hidden;
            /* 4K é«˜æ¸…æ«»èŠ± */
            background: url('https://images.unsplash.com/photo-1522383225653-ed111181a951?q=100&w=2560&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            background-position: center bottom;
        }

        /* æ«»èŠ±ç‰¹æ•ˆ */
        #sakura-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
        }
        .petal {
            position: absolute;
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 150% 0 150% 0;
            animation: fall linear infinite;
            opacity: 0.9;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
        }
        @keyframes fall {
            0% { opacity: 0; transform: translate(0, -10vh) rotate(0deg); }
            100% { opacity: 1; transform: translate(100px, 110vh) rotate(360deg); }
        }

        /* ä»‹é¢ */
        .container {
            position: relative; z-index: 10;
            background: var(--card-bg);
            padding: 1.2rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 2px solid white;
            width: 90%; max-width: 450px;
            display: flex; flex-direction: column; align-items: center;
        }

        .header { width: 100%; margin-bottom: 0.5rem; border-bottom: 2px dashed #ffc3a0; padding-bottom: 8px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        h1 { font-size: 1.4rem; margin: 0; color: var(--primary-dark); }
        .progress-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }

        /* èªéŸ³é¸æ“‡ */
        .voice-box { background: #fff0f5; padding: 6px; border-radius: 8px; width: 100%; border: 1px solid #ffb7b2; }
        .voice-box label { display: block; font-size: 0.75rem; color: #d63031; font-weight: bold; margin-bottom: 2px; }
        select { width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.85rem; background: white; }

        .control-panel { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; margin-top: 5px; }
        .category-scroll { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 2px; width: 100%; justify-content: center;}
        .chip { padding: 5px 12px; border-radius: 20px; background: white; border: 1px solid #ffc3a0; color: #2d3436; font-size: 0.85rem; font-weight: bold; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .chip.active { background: var(--primary); color: white; transform: scale(1.05); border-color: var(--primary); }

        .toggle-box { display: flex; justify-content: center; gap: 8px; }
        .mode-btn { padding: 5px 12px; border-radius: 20px; border: 1px solid #ccc; background: white; color: #666; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .mode-btn.active { background: var(--primary-dark); color: white; border-color: var(--primary-dark); }

        .flashcard {
            width: 160px; height: 180px; background: white; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 3px solid #ffeaa7;
            cursor: pointer; margin-bottom: 10px; transition: transform 0.1s;
        }
        .flashcard:active { transform: scale(0.96); }
        .flashcard.wrong { border-color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-8px);} 75%{transform:translateX(8px);} }

        .kana-char { font-size: 4rem; font-weight: 700; color: #2d3436; line-height: 1; }
        .romaji-hint { font-size: 1.1rem; color: #b2bec3; margin-top: 5px; }

        .input-area { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* è²æ³¢è¦–è¦ºåŒ– */
        .visualizer { display: flex; gap: 3px; height: 15px; align-items: flex-end; margin-bottom: 5px; opacity: 0.2; transition: opacity 0.2s; }
        .visualizer.active { opacity: 1; }
        .bar { width: 5px; height: 3px; background: #2ecc71; border-radius: 2px; transition: height 0.05s; }

        .status-text { font-size: 0.95rem; font-weight: bold; color: #636e72; margin-bottom: 10px; text-align: center; min-height: 1.4rem; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .mic-btn {
            width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, #ff9a9e, #ff6b6b);
            border: 4px solid white; color: white; font-size: 1.8rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
        }
        .mic-btn.listening { background: #ff7675; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,118,117,0.6);} 70%{box-shadow:0 0 0 15px rgba(0,0,0,0);} 100%{box-shadow:0 0 0 0 rgba(0,0,0,0);} }

        #text-input { display: none; width: 200px; padding: 10px; font-size: 1.1rem; text-align: center; border: 2px solid #ccc; border-radius: 50px; outline: none; }
        #text-input:focus { border-color: var(--primary); }

        #result-view { display: none; width: 100%; text-align: center; }
        .score-box { width: 100px; height: 100px; border-radius: 50%; background: white; border: 4px solid var(--primary); margin: 0 auto 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; color: var(--primary-dark); }
        .restart-btn { width: 100%; padding: 12px; background: var(--primary-dark); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; margin-top: 15px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="sakura-container"></div>

    <div class="container">
        <!-- ç·´ç¿’ä»‹é¢ -->
        <div id="practice-view" style="width:100%">
            <div class="header">
                <div class="header-row">
                    <h1>äº”åéŸ³ç‰¹è¨“</h1>
                    <div class="progress-badge" id="progress">1 / 25</div>
                </div>
                <!-- ç™¼éŸ³äººé¸æ“‡ -->
                <div class="voice-box">
                    <label>ğŸ”Š ç™¼éŸ³äºº (ç„¡è²è«‹åˆ‡æ›)</label>
                    <select id="voice-select" onchange="testVoice()"><option>è¼‰å…¥ä¸­...</option></select>
                </div>
            </div>

            <div class="control-panel">
                <div class="category-scroll">
                    <div class="chip active" onclick="changeCat('seion', this)">æ¸…éŸ³</div>
                    <div class="chip" onclick="changeCat('dakuon', this)">æ¿éŸ³</div>
                    <div class="chip" onclick="changeCat('handakuon', this)">åŠæ¿éŸ³</div>
                    <div class="chip" onclick="changeCat('yoon', this)">æ‹—éŸ³</div>
                    <div class="chip" onclick="changeCat('all', this)">å…¨éƒ¨</div>
                </div>

                <div class="toggle-box">
                    <button class="mode-btn active" id="m-voice" onclick="setMode('voice')">ğŸ¤ èªéŸ³</button>
                    <button class="mode-btn" id="m-type" onclick="setMode('type')">âŒ¨ï¸ æ‰“å­—</button>
                    <span>|</span>
                    <button class="mode-btn active" onclick="setKana('h', this)">å¹³å‡å</button>
                    <button class="mode-btn" onclick="setKana('k', this)">ç‰‡å‡å</button>
                </div>
            </div>

            <!-- å¡ç‰‡ -->
            <div class="flashcard" id="card" onclick="speakCurrent()">
                <div class="kana-char" id="kana">ã‚</div>
                <div class="romaji-hint" id="romaji">a</div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:auto; margin-bottom:8px;">ğŸ”Š é»æ“Šè½ç™¼éŸ³</div>
            </div>

            <!-- è¼¸å…¥èˆ‡å›é¥‹ -->
            <div class="input-area">
                <div class="visualizer" id="vis">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <div class="status-text" id="status">æº–å‚™å°±ç·’</div>
                
                <button id="mic-btn" class="mic-btn" onclick="toggleMic()">ğŸ¤</button>
                <input type="text" id="text-input" placeholder="è¼¸å…¥ç­”æ¡ˆ (å¦‚ a)" autocomplete="off">
            </div>
        </div>

        <!-- çµç®—ä»‹é¢ -->
        <div id="result-view">
            <h2 style="color: #e84393;">ğŸŒ¸ ç·´ç¿’çµæŸ ğŸŒ¸</h2>
            <div class="score-box" id="score">0</div>
            <div id="mistake-list" style="text-align:left; max-height:250px; overflow-y:auto; width:100%; padding:5px;"></div>
            <button class="restart-btn" onclick="resetGame()">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>

    <script>
        // ğŸŒ¸ æ«»èŠ±ç‰¹æ•ˆ
        function createSakura() {
            const c = document.getElementById('sakura-container');
            const p = document.createElement('div'); 
            p.className = 'petal';
            const size = Math.random() * 12 + 8; 
            p.style.width = size + 'px'; p.style.height = size + 'px';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (Math.random() * 5 + 5) + 's';
            c.appendChild(p);
            setTimeout(() => p.remove(), 10000);
        }
        setInterval(createSakura, 100);

        // --- è³‡æ–™åº« (å®Œæ•´) ---
        const DB = {
            seion: [{r:'a',h:'ã‚',k:'ã‚¢'},{r:'i',h:'ã„',k:'ã‚¤'},{r:'u',h:'ã†',k:'ã‚¦'},{r:'e',h:'ãˆ',k:'ã‚¨'},{r:'o',h:'ãŠ',k:'ã‚ª'},{r:'ka',h:'ã‹',k:'ã‚«'},{r:'ki',h:'ã',k:'ã‚­'},{r:'ku',h:'ã',k:'ã‚¯'},{r:'ke',h:'ã‘',k:'ã‚±'},{r:'ko',h:'ã“',k:'ã‚³'},{r:'sa',h:'ã•',k:'ã‚µ'},{r:'shi',h:'ã—',k:'ã‚·'},{r:'su',h:'ã™',k:'ã‚¹'},{r:'se',h:'ã›',k:'ã‚»'},{r:'so',h:'ã',k:'ã‚½'},{r:'ta',h:'ãŸ',k:'ã‚¿'},{r:'chi',h:'ã¡',k:'ãƒ'},{r:'tsu',h:'ã¤',k:'ãƒ„'},{r:'te',h:'ã¦',k:'ãƒ†'},{r:'to',h:'ã¨',k:'ãƒˆ'},{r:'na',h:'ãª',k:'ãƒŠ'},{r:'ni',h:'ã«',k:'ãƒ‹'},{r:'nu',h:'ã¬',k:'ãƒŒ'},{r:'ne',h:'ã­',k:'ãƒ'},{r:'no',h:'ã®',k:'ãƒ'},{r:'ha',h:'ã¯',k:'ãƒ'},{r:'hi',h:'ã²',k:'ãƒ’'},{r:'fu',h:'ãµ',k:'ãƒ•'},{r:'he',h:'ã¸',k:'ãƒ˜'},{r:'ho',h:'ã»',k:'ãƒ›'},{r:'ma',h:'ã¾',k:'ãƒ'},{r:'mi',h:'ã¿',k:'ãƒŸ'},{r:'mu',h:'ã‚€',k:'ãƒ '},{r:'me',h:'ã‚',k:'ãƒ¡'},{r:'mo',h:'ã‚‚',k:'ãƒ¢'},{r:'ya',h:'ã‚„',k:'ãƒ¤'},{r:'yu',h:'ã‚†',k:'ãƒ¦'},{r:'yo',h:'ã‚ˆ',k:'ãƒ¨'},{r:'ra',h:'ã‚‰',k:'ãƒ©'},{r:'ri',h:'ã‚Š',k:'ãƒª'},{r:'ru',h:'ã‚‹',k:'ãƒ«'},{r:'re',h:'ã‚Œ',k:'ãƒ¬'},{r:'ro',h:'ã‚',k:'ãƒ­'},{r:'wa',h:'ã‚',k:'ãƒ¯'},{r:'wo',h:'ã‚’',k:'ãƒ²'},{r:'n',h:'ã‚“',k:'ãƒ³'}],
            dakuon: [{r:'ga',h:'ãŒ',k:'ã‚¬'},{r:'gi',h:'ã',k:'ã‚®'},{r:'gu',h:'ã',k:'ã‚°'},{r:'ge',h:'ã’',k:'ã‚²'},{r:'go',h:'ã”',k:'ã‚´'},{r:'za',h:'ã–',k:'ã‚¶'},{r:'ji',h:'ã˜',k:'ã‚¸'},{r:'zu',h:'ãš',k:'ã‚º'},{r:'ze',h:'ãœ',k:'ã‚¼'},{r:'zo',h:'ã',k:'ã‚¾'},{r:'da',h:'ã ',k:'ãƒ€'},{r:'ji',h:'ã¢',k:'ãƒ‚'},{r:'zu',h:'ã¥',k:'ãƒ…'},{r:'de',h:'de',k:'ãƒ‡'},{r:'do',h:'ã©',k:'ãƒ‰'},{r:'ba',h:'ã°',k:'ãƒ'},{r:'bi',h:'ã³',k:'ãƒ“'},{r:'bu',h:'ã¶',k:'ãƒ–'},{r:'be',h:'ã¹',k:'ãƒ™'},{r:'bo',h:'ã¼',k:'ãƒœ'}],
            handakuon: [{r:'pa',h:'ã±',k:'ãƒ‘'},{r:'pi',h:'ã´',k:'ãƒ”'},{r:'pu',h:'ã·',k:'ãƒ—'},{r:'pe',h:'ãº',k:'ãƒš'},{r:'po',h:'ã½',k:'ãƒ'}],
            yoon: [{r:'kya',h:'ãã‚ƒ',k:'ã‚­ãƒ£'},{r:'kyu',h:'ãã‚…',k:'ã‚­ãƒ¥'},{r:'kyo',h:'ãã‚‡',k:'ã‚­ãƒ§'},{r:'sha',h:'ã—ã‚ƒ',k:'ã‚·ãƒ£'},{r:'shu',h:'ã—ã‚…',k:'ã‚·ãƒ¥'},{r:'sho',h:'ã—ã‚‡',k:'ã‚·ãƒ§'},{r:'cha',h:'ã¡ã‚ƒ',k:'ãƒãƒ£'},{r:'chu',h:'ã¡ã‚…',k:'ãƒãƒ¥'},{r:'cho',h:'ã¡ã‚‡',k:'ãƒãƒ§'},{r:'nya',h:'ã«ã‚ƒ',k:'ãƒ‹ãƒ£'},{r:'nyu',h:'ã«ã‚…',k:'ãƒ‹ãƒ¥'},{r:'nyo',h:'ã«ã‚‡',k:'ãƒ‹ãƒ§'},{r:'hya',h:'ã²ã‚ƒ',k:'ãƒ’ãƒ£'},{r:'hyu',h:'ã²ã‚…',k:'ãƒ’ãƒ¥'},{r:'hyo',h:'ã²ã‚‡',k:'ãƒ’ãƒ§'},{r:'mya',h:'ã¿ã‚ƒ',k:'ãƒŸãƒ£'},{r:'myu',h:'ã¿ã‚…',k:'ãƒŸãƒ¥'},{r:'myo',h:'ã¿ã‚‡',k:'ãƒŸãƒ§'},{r:'rya',h:'ã‚Šã‚ƒ',k:'ãƒªãƒ£'},{r:'ryu',h:'ã‚Šã‚…',k:'ãƒªãƒ¥'},{r:'ryo',h:'ã‚Šã‚‡',k:'ãƒªãƒ§'},{r:'gya',h:'ãã‚ƒ',k:'ã‚®ãƒ£'},{r:'gyu',h:'ãã‚…',k:'ã‚®ãƒ¥'},{r:'gyo',h:'ãã‚‡',k:'ã‚®ãƒ§'},{r:'ja',h:'ã˜ã‚ƒ',k:'ã‚¸ãƒ£'},{r:'ju',h:'ã˜ã‚…',k:'ã‚¸ãƒ¥'},{r:'jo',h:'ã˜ã‚‡',k:'ã‚¸ãƒ§'},{r:'bya',h:'ã³ã‚ƒ',k:'ãƒ“ãƒ£'},{r:'byu',h:'ã³ã‚…',k:'ãƒ“ãƒ¥'},{r:'byo',h:'ã³ã‚‡',k:'ãƒ“ãƒ§'},{r:'pya',h:'ã´ã‚ƒ',k:'ãƒ”ãƒ£'},{r:'pyu',h:'ã´ã‚…',k:'ãƒ”ãƒ¥'},{r:'pyo',h:'ã´ã‚‡',k:'ãƒ”ãƒ§'}]
        };

        // --- å…¨äº”åéŸ³æç¤ºè©åˆ—è¡¨ (Grammar Hints) ---
        // é€™æœƒå‘Šè¨´èªéŸ³è­˜åˆ¥å¼•æ“ï¼šåªå°ˆæ³¨è½é€™äº›å­—
        const ALL_KANA = [
            'ã‚','ã„','ã†','ãˆ','ãŠ', 'ã‹','ã','ã','ã‘','ã“', 'ã•','ã—','ã™','ã›','ã',
            'ãŸ','ã¡','ã¤','ã¦','ã¨', 'ãª','ã«','ã¬','ã­','ã®', 'ã¯','ã²','ãµ','ã¸','ã»',
            'ã¾','ã¿','ã‚€','ã‚','ã‚‚', 'ã‚„','ã‚†','ã‚ˆ', 'ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚', 'ã‚','ã‚’','ã‚“',
            'ãŒ','ã','ã','ã’','ã”', 'ã–','ã˜','ãš','ãœ','ã', 'ã ','ã¢','ã¥','ã§','ã©',
            'ã°','ã³','ã¶','ã¹','ã¼', 'ã±','ã´','ã·','ãº','ã½',
            'ãã‚ƒ','ãã‚…','ãã‚‡', 'ã—ã‚ƒ','ã—ã‚…','ã—ã‚‡', 'ã¡ã‚ƒ','ã¡ã‚…','ã¡ã‚‡',
            'ã«ã‚ƒ','ã«ã‚…','ã«ã‚‡', 'ã²ã‚ƒ','ã²ã‚…','ã²ã‚‡', 'ã¿ã‚ƒ','ã¿ã‚…','ã¿ã‚‡',
            'ã‚Šã‚ƒ','ã‚Šã‚…','ã‚Šã‚‡', 'ãã‚ƒ','ãã‚…','ãã‚‡', 'ã˜ã‚ƒ','ã˜ã‚…','ã˜ã‚‡',
            'ã³ã‚ƒ','ã³ã‚…','ã³ã‚‡', 'ã´ã‚ƒ','ã´ã‚…','ã´ã‚‡'
        ];

        // ç‹€æ…‹
        let gameState = {
            mode: 'voice', kana: 'h', cat: 'seion',
            qCount: 0, correct: 0, current: null,
            isListening: false
        };
        
        let voices = [];
        let recognition = null;
        let audioContext, analyser, micSource, scriptNode;
        let globalMistakes = JSON.parse(localStorage.getItem('gojuon_smart_mistakes')) || {};

        // --- 1. èªéŸ³åˆæˆ (TTS) ---
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            const select = document.getElementById('voice-select');
            
            if (voices.length > 0) {
                select.innerHTML = '';
                let foundJP = false;
                voices.forEach((v, i) => {
                    if(v.lang.includes('ja') || v.lang.includes('JP')) {
                        let opt = document.createElement('option');
                        opt.value = i;
                        opt.text = v.name;
                        select.appendChild(opt);
                        foundJP = true;
                    }
                });
                // é è¨­é¸ä¸­ Google æ—¥æœ¬èª
                const googleIdx = voices.findIndex(v => v.name.includes('Google') && v.lang.includes('ja'));
                if(googleIdx !== -1) select.value = googleIdx;
                else if(!foundJP) {
                    let opt = document.createElement('option');
                    opt.text = "ç³»çµ±é è¨­ (ç„¡æ—¥èªåŒ…)";
                    select.appendChild(opt);
                }
            } else {
                setTimeout(loadVoices, 300); // Retry
            }
        }
        if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            const idx = document.getElementById('voice-select').value;
            if(voices[idx]) u.voice = voices[idx];
            window.speechSynthesis.speak(u);
        }
        function speakCurrent() { if(gameState.current) speak(gameState.current.h); }
        function testVoice() { speak("ã“ã‚“ã«ã¡ã¯"); }

        // --- 2. èªéŸ³è­˜åˆ¥ (SpeechRecognition) ---
        function initSpeech() {
            if(!('webkitSpeechRecognition' in window)) {
                document.getElementById('status').innerText = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³";
                return;
            }

            // å»ºç«‹ Grammar List (é—œéµå„ªåŒ–)
            const SpeechGrammarList = window.SpeechGrammarList || window.webkitSpeechGrammarList;
            const speechRecognitionList = new SpeechGrammarList();
            const grammar = '#JSGF V1.0; grammar kana; public <kana> = ' + ALL_KANA.join(' | ') + ' ;';
            speechRecognitionList.addFromString(grammar, 1);

            recognition = new webkitSpeechRecognition();
            recognition.grammars = speechRecognitionList; // æ‡‰ç”¨æç¤ºè©
            recognition.lang = 'ja-JP'; // å¼·åˆ¶æ—¥èª
            recognition.continuous = false;
            recognition.interimResults = true; // é–‹å•Ÿå³æ™‚å›é¥‹
            recognition.maxAlternatives = 5;   // ç²å–æ›´å¤šå€™é¸å­—

            recognition.onstart = () => {
                gameState.isListening = true;
                document.getElementById('mic-btn').classList.add('listening');
                document.getElementById('status').innerText = "è†è½ä¸­...";
                startVisualizer();
            };

            recognition.onend = () => {
                gameState.isListening = false;
                document.getElementById('mic-btn').classList.remove('listening');
                document.getElementById('vis').classList.remove('active');
            };

            recognition.onresult = (e) => {
                let final = "";
                // å„ªå…ˆè™•ç†æœ€çµ‚çµæœ
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        final = e.results[i][0].transcript;
                        checkAnswer(final);
                    } else {
                        document.getElementById('status').innerText = `...${e.results[i][0].transcript}`;
                    }
                }
            };
            
            recognition.onerror = (e) => {
                document.getElementById('status').innerText = "âŒ éŒ¯èª¤: " + e.error;
                if(e.error === 'no-speech') document.getElementById('status').innerText = "âŒ æ²’è½åˆ°è²éŸ³";
            };
        }

        function toggleMic() {
            if(!recognition) initSpeech();
            if(!recognition) return;

            if(gameState.isListening) {
                recognition.stop();
            } else {
                // iOS Wakeup
                const ctx = new (window.AudioContext || window.we